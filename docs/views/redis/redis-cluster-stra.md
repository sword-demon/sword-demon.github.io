---
title: Redis Cluster集群
date: 2023-01-05 21:05:10
category: Redis
tag:
    - redis
---

# Redis Cluster 集群

主要是以多主多从的集群方式来保证高可用高并发。

```mermaid
graph LR;
　　user --> master1;
　　user --> master2;
　　user --> master3;
　　master1 --> slave1
　　master2 --> slave2
　　master3 --> slave3
```

## 特点

-   无中心的结构，数据分散在各个节点上，并且保存了整个集群的状态，每个节点都和其他节点相连
-   官方规定最小需要 6 个节点，3 个主节点和 3 个从节点
-   各个节点是通过`gossip`协议交换数据的，数据分布采用哈希槽算法实现，有一个`crc16(key) % 16384`取模的`redis key`路由公式。

```mermaid
graph LR;
　　user --> 0-5460哈希槽1;
　　user --> 5461-10922哈希槽2;
　　user --> 10923-16383哈希槽3;
　　0-5460哈希槽1 --> 节点1
　　5461-10922哈希槽2 --> 节点2
　　10923-16383哈希槽3 --> 节点3
```

:::tip

`crc16`算法的`hash`值最大是 65535，为什么不创建 65535 个槽位呢？

> `redis`节点发送的心跳包需要把所有的槽位信息放到心跳包中，方便节点知道集群信息；压缩以后大小是 2k；虽然最大 65535 压缩为 8k，作者认为 8k 的心跳包浪费，一般一个 redis 集群也不会超过 1000 个 master 节点，所以 16384 是比较合适的。

:::

## gossip 协议

`Gossip`协议，就像流言蜚语一样，利用一种随机性、带有传染性的方式，将信息传播到整个网络中，并在一定时间内，使得系统内的所有节点数据一致。实现最终一致性。

所有节点都持有一份元数据，不同的节点如果出现了元数据变更以后，就不断的将元数据发送给其他节点，让其他节点也进行元数据的变更。
