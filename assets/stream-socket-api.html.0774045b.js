import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";import{r as p,o as t,c as o,a as n,b as c,d as s,e as l}from"./app.2badf842.js";const i={},u=n("h2",{id:"stream-socket-api-\u51FD\u6570\u4ECB\u7ECD",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#stream-socket-api-\u51FD\u6570\u4ECB\u7ECD","aria-hidden":"true"},"#"),s(" Stream socket api \u51FD\u6570\u4ECB\u7ECD")],-1),r=n("blockquote",null,[n("p",null,"PHP \u5BF9 socket \u7684\u5C01\u88C5\u63D0\u4F9B\u4E86\u5F88\u591A\u51FD\u6570\uFF0C\u4F46\u662F\u5176\u5185\u90E8\u4F7F\u7528\u7684 socket api \u51FD\u6570\u548C\u522B\u7684\u8BED\u8A00\u90FD\u662F\u4E00\u6837\u7684\u3002")],-1),k=n("ul",null,[n("li",null,"stream"),n("li",null,"event\uFF1APHP \u91CC\u7684\u4E00\u4E2A\u6269\u5C55\u3010libevent \u7F51\u7EDC\u5E93\u3011\uFF0C\u5B83\u662F\u7528 C \u8BED\u8A00\u5F00\u53D1\u7684\uFF0C\u5185\u90E8\u4F7F\u7528\u7684 socket api \u51FD\u6570\u90FD\u662F\u4E00\u6837\u7684\uFF0C\u4E0D\u8FC7 PHP \u518D\u5C01\u88C5\u4E86\u4E00\u5C42\uFF0C\u8BA9 PHP \u6765\u8FDB\u884C\u4F7F\u7528\u3002"),n("li",null,"swoole"),n("li",null,"\u7B49\u3002\u3002\u3002")],-1),d={href:"https://www.php.net/manual/zh/function.stream-socket-server.php",target:"_blank",rel:"noopener noreferrer"},m=s("stream_socket_server \u51FD\u6570\u6587\u6863\u5730\u5740"),v=l(`<div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token function">stream_socket_server</span><span class="token punctuation">(</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$address</span><span class="token punctuation">,</span>
    <span class="token keyword type-declaration">int</span> <span class="token operator">&amp;</span><span class="token variable">$error_code</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
    <span class="token keyword type-declaration">string</span> <span class="token operator">&amp;</span><span class="token variable">$error_message</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">int</span> <span class="token variable">$flags</span> <span class="token operator">=</span> <span class="token class-name">STREAM_SERVER_BIND</span> <span class="token operator">|</span> <span class="token class-name">STREAM_SERVER_LISTEN</span><span class="token punctuation">,</span>
    <span class="token operator">?</span><span class="token class-name type-declaration">resource</span> <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token constant">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">resource</span><span class="token operator">|</span><span class="token keyword type-declaration">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// socket()</span>
<span class="token comment">// bind()</span>
<span class="token comment">// listen</span>
<span class="token comment">// \u5185\u90E8\u8C03\u7528\u4F7F\u7528\u4E86\u4E0A\u97623\u4E2A\u51FD\u6570</span>
<span class="token variable">$sock</span> <span class="token operator">=</span> <span class="token function">stream_socket_server</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;tcp://0.0.0.0:12345&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// \u63A5\u6536\u4E00\u4E2A\u5BA2\u6237\u7AEF\u8FDE\u63A5</span>
<span class="token comment">// -1 \u8D85\u65F6\u65F6\u95F4\uFF0C\u7B49\u5230\u6709\u8FDE\u63A5\u4E3A\u6B62</span>
<span class="token variable">$conn</span> <span class="token operator">=</span> <span class="token function">stream_socket_accept</span><span class="token punctuation">(</span><span class="token variable">$sock</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5185\u90E8\u8C03\u7528\u51FD\u6570\uFF1A<code>strace -f -s 6550 php stream1.php</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>socket<span class="token punctuation">(</span>AF_INET, SOCK_STREAM, IPPROTO_IP<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
setsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_REUSEADDR, <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
bind<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET, <span class="token assign-left variable">sin_port</span><span class="token operator">=</span>htons<span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span>, <span class="token assign-left variable">sin_addr</span><span class="token operator">=</span>inet_addr<span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>, <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
listen<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">32</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>setsockopt\uFF1A\u8BBE\u7F6E\u5957\u63A5\u5B57\u7684\u4E00\u4E9B\u5C5E\u6027</li><li>htons\uFF1A\u628A\u4E3B\u673A\u5B57\u8282\u5E8F\u8F6C\u6362\u4E3A\u7F51\u7EDC\u5B57\u8282\u5E8F</li><li>listen\uFF1A\u9ED8\u8BA4\u76D1\u542C\u961F\u5217\u6700\u5927\u957F\u5EA6\u4E3A 32</li><li>\u8FD8\u4F7F\u7528\u4E86<code>poll</code> IO \u591A\u8DEF\u590D\u7528\u51FD\u6570\uFF1A<code>oll([{fd=3, events=POLLIN|POLLERR|POLLHUP}], 1, 1271309319</code></li></ul><p>\u4F7F\u7528<code>curl</code>\u6765\u8FDE\u63A5\u670D\u52A1\u7AEF\u6D4B\u8BD5\u8C03\u7528\u7684\u5185\u5BB9</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token number">127.0</span>.0.1:12345
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>accept<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET, <span class="token assign-left variable">sin_port</span><span class="token operator">=</span>htons<span class="token punctuation">(</span><span class="token number">47412</span><span class="token punctuation">)</span>, <span class="token assign-left variable">sin_addr</span><span class="token operator">=</span>inet_addr<span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>, <span class="token punctuation">[</span><span class="token number">128</span>-<span class="token operator">&gt;</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">&quot;Resource id #6&quot;</span>, 14Resource <span class="token function">id</span> <span class="token comment">#6)          = 14</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">&quot;127.0.0.1:47412&quot;</span>, <span class="token number">15127.0</span>.0.1:47412<span class="token punctuation">)</span>         <span class="token operator">=</span> <span class="token number">15</span>
close<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
close<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
close<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>\u5BA2\u6237\u7AEF</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// \u8FDE\u63A5\u670D\u52A1\u7AEF\u7A0B\u5E8F</span>
<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token function">stream_socket_client</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;tcp://127.0.0.1:12345&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// php \u5C01\u88C5\u4E3A\u4E00\u4E2A\u8D44\u6E90</span>

<span class="token keyword">echo</span> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$client</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// \u76F4\u63A5\u5173\u95ED</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$client</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u518D\u914D\u5408\u670D\u52A1\u7AEF\u8FDB\u884C\u8FD0\u884C</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>socket<span class="token punctuation">(</span>AF_INET, SOCK_STREAM, IPPROTO_IP<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span>
fcntl<span class="token punctuation">(</span><span class="token number">3</span>, F_GETFL<span class="token punctuation">)</span>                       <span class="token operator">=</span> 0x2 <span class="token punctuation">(</span>flags O_RDWR<span class="token punctuation">)</span>
fcntl<span class="token punctuation">(</span><span class="token number">3</span>, F_SETFL, O_RDWR<span class="token operator">|</span>O_NONBLOCK<span class="token punctuation">)</span>    <span class="token operator">=</span> <span class="token number">0</span>
connect<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token punctuation">{</span>sa_family<span class="token operator">=</span>AF_INET, <span class="token assign-left variable">sin_port</span><span class="token operator">=</span>htons<span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span>, <span class="token assign-left variable">sin_addr</span><span class="token operator">=</span>inet_addr<span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>, <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> -1 EINPROGRESS <span class="token punctuation">(</span>Operation now <span class="token keyword">in</span> progress<span class="token punctuation">)</span>
poll<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">events</span><span class="token operator">=</span>POLLIN<span class="token operator">|</span>POLLOUT<span class="token operator">|</span>POLLERR<span class="token operator">|</span>POLLHUP<span class="token punctuation">}</span><span class="token punctuation">]</span>, <span class="token number">1</span>, <span class="token number">60000</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>fd<span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">revents</span><span class="token operator">=</span>POLLOUT<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
getsockopt<span class="token punctuation">(</span><span class="token number">3</span>, SOL_SOCKET, SO_ERROR, <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
fcntl<span class="token punctuation">(</span><span class="token number">3</span>, F_SETFL, O_RDWR<span class="token punctuation">)</span>               <span class="token operator">=</span> <span class="token number">0</span>
sendto<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token string">&quot;hello world&quot;</span>, <span class="token number">11</span>, MSG_DONTWAIT, NULL, <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">11</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">&quot;11&quot;</span>, <span class="token number">211</span><span class="token punctuation">)</span>                       <span class="token operator">=</span> <span class="token number">2</span>
close<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                                <span class="token operator">=</span> <span class="token number">0</span>
close<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>fcntl(3, F_SETFL, O_RDWR|O_NONBLOCK) = 0\uFF1A\u8BBE\u7F6E\u4E3A\u975E\u963B\u585E\u65B9\u5F0F</li><li>\u5185\u90E8\u4F7F\u7528<code>connect</code>\u7CFB\u7EDF\u8C03\u7528\u51FD\u6570\u8FDE\u63A5<code>12345</code>\u7684\u7AEF\u53E3\u7684\u5730\u5740</li><li>\u4F7F\u7528<code>sendto</code>\u53D1\u9001&quot;hello world&quot;</li><li>\u670D\u52A1\u7AEF\u5728\u4F7F\u7528<code>read</code>\u51FD\u6570\u6765\u83B7\u53D6\u5185\u5BB9\uFF0C11 \u4E2A\u5B57\u8282\uFF0C\u4E14\u4E0D\u963B\u585E\u4E86\uFF1A<code>MSG_DONTWAIT</code></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>recvfrom<span class="token punctuation">(</span><span class="token number">4</span>, <span class="token string">&quot;hello world&quot;</span>, <span class="token number">8192</span>, MSG_DONTWAIT, NULL, NULL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">11</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">&quot;hello world&quot;</span>, 11hello world<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,15);function b(_,h){const a=p("ExternalLinkIcon");return t(),o("div",null,[u,r,k,n("p",null,[n("a",d,[m,c(a)])]),v])}var O=e(i,[["render",b],["__file","stream-socket-api.html.vue"]]);export{O as default};
